# UMAYOMI システムアーキテクチャ仕様書

**UMAYOMI - 馬を読む。レースが変わる。**

---

## 📋 目次

1. [概要](#概要)
2. [システム構成](#システム構成)
3. [2つのモード](#2つのモード)
4. [データソース](#データソース)
5. [ファクター設計](#ファクター設計)
6. [ワークフロー](#ワークフロー)
7. [技術スタック](#技術スタック)
8. [開発フェーズ](#開発フェーズ)

---

## 概要

### 一言で言うと
**JRDBとJRA-VANの競馬ビッグデータ（10年分・252+αフィールド）をAI分析して、的中率を最大化する次世代競馬予測システム**

### 3つの特徴
1. **マルチデータソース**
   - JRDB 2016-2025年データ（252フィールド）
   - JRA-VAN TFJVデータ（レース結果・払戻金など）
   - 2つのデータソースを自由に組み合わせ可能

2. **柔軟なファクター設計**
   - CEO専用の開発者モードで独自ロジック作成
   - ユーザーが既存ファクターを自由に組み合わせ
   - バックテストで精度を即座に検証

3. **48時間で構築**
   - Enable憲法に基づく超高速開発
   - Cloudflare Pages + Hono + PostgreSQL
   - AIとスピードで市場を制圧

---

## システム構成

```
┌─────────────────────────────────────────────────────┐
│                   UMAYOMI System                    │
├─────────────────────────────────────────────────────┤
│                                                     │
│  ┌──────────────────┐  ┌──────────────────┐      │
│  │ 開発者モード      │  │ ユーザーモード    │      │
│  │ (CEO専用)        │  │ (一般公開)       │      │
│  ├──────────────────┤  ├──────────────────┤      │
│  │ ファクター作成   │  │ 予測結果表示     │      │
│  │ バックテスト     │  │ ファクター選択   │      │
│  │ データ分析       │  │ 推奨買い目       │      │
│  └────────┬─────────┘  └────────┬─────────┘      │
│           │                      │                 │
│           └──────────┬───────────┘                 │
│                      ↓                             │
│         ┌────────────────────────┐                 │
│         │   ファクターエンジン    │                 │
│         │  (予測ロジック実行)    │                 │
│         └────────────┬───────────┘                 │
│                      ↓                             │
│         ┌────────────────────────┐                 │
│         │  PostgreSQL Database   │                 │
│         ├────────────────────────┤                 │
│         │ • JRDB (252フィールド) │                 │
│         │ • JRA-VAN (TFJV)       │                 │
│         │ • ファクター定義       │                 │
│         │ • バックテスト結果     │                 │
│         └────────────┬───────────┘                 │
│                      ↓                             │
│         ┌────────────────────────┐                 │
│         │   データ取り込み層      │                 │
│         ├────────────────────────┤                 │
│         │ • JRDB Parser          │                 │
│         │ • JRA-VAN Parser       │                 │
│         │ • データ正規化         │                 │
│         └────────────────────────┘                 │
│                                                     │
└─────────────────────────────────────────────────────┘
```

---

## 2つのモード

### 1. 開発者モード（CEO専用）

#### 目的
CEOが独自の予測ロジック（ファクター）を作成・検証・最適化

#### 主な機能

```
┌─────────────────────────────────────────┐
│ UMAYOMI Developer Console               │
├─────────────────────────────────────────┤
│                                          │
│ [1] ファクター作成                      │
│ ┌──────────────────────────────────┐   │
│ │ ファクター名: 蹄状態×騎手重視   │   │
│ │                                  │   │
│ │ データソース選択:                │   │
│ │ ☑ JRDB (252フィールド)          │   │
│ │ ☑ JRA-VAN (TFJV)                │   │
│ │                                  │   │
│ │ 条件設定 (JRDB):                 │   │
│ │ ☑ 蹄コード = 11 (良好)           │   │
│ │ ☑ 騎手指数 >= 70                 │   │
│ │ ☑ 馬体重増減 >= -5 ~ +5          │   │
│ │                                  │   │
│ │ 条件設定 (JRA-VAN):              │   │
│ │ ☑ 過去3走平均着順 <= 3           │   │
│ │ ☑ 芝実績 >= 50%                  │   │
│ │                                  │   │
│ │ 重み付け:                        │   │
│ │ - JRDB蹄状態: 30%                │   │
│ │ - JRDB騎手指数: 25%              │   │
│ │ - JRA-VAN過去成績: 25%           │   │
│ │ - 馬体重: 20%                    │   │
│ └──────────────────────────────────┘   │
│                                          │
│ [2] バックテスト実行                    │
│ ┌──────────────────────────────────┐   │
│ │ 期間: 2023-01-01 ~ 2024-12-31    │   │
│ │ 対象: 全レース                   │   │
│ │                                  │   │
│ │ 結果:                            │   │
│ │ ━━━━━━━━━━━━━━━━━━━━━━━━━━━   │   │
│ │ 的中率:    68.5% (856/1,250)     │   │
│ │ 回収率:   112.3%                 │   │
│ │ 平均配当: ¥1,230                 │   │
│ │ サンプル: 1,250レース            │   │
│ │                                  │   │
│ │ 馬場別成績:                      │   │
│ │ • 芝良: 72.3% (回収率 118%)      │   │
│ │ • 芝稍重: 65.1% (回収率 105%)    │   │
│ │ • ダート良: 64.8% (回収率 108%)  │   │
│ └──────────────────────────────────┘   │
│                                          │
│ [3] ファクター管理                      │
│ ┌──────────────────────────────────┐   │
│ │ 保存済みファクター (15件)        │   │
│ │                                  │   │
│ │ 1. 蹄状態×騎手重視    (68.5%)   │   │
│ │ 2. オッズ逆張り戦略    (71.2%)   │   │
│ │ 3. 距離適性重視        (65.8%)   │   │
│ │ 4. 調教師×馬場        (69.3%)   │   │
│ │ ...                              │   │
│ │                                  │   │
│ │ [ファクターを公開する]           │   │
│ └──────────────────────────────────┘   │
│                                          │
└─────────────────────────────────────────┘
```

#### できること
1. ✅ **252+αフィールドから自由に条件設定**
   - JRDB: 蹄データ、騎手指数、馬体重、オッズなど
   - JRA-VAN: レース結果、払戻金、芝・ダート実績など

2. ✅ **データソースを組み合わせ**
   - JRDBとJRA-VANの両方から条件選択
   - 重み付けで最適化

3. ✅ **バックテストで検証**
   - 過去10年データで的中率・回収率を即座に計算
   - 馬場別、距離別、クラス別の詳細分析

4. ✅ **ファクター保存・管理**
   - 複数のファクターを作成
   - 任意でユーザーモードに公開

---

### 2. ユーザーモード（一般公開）

#### 目的
一般ユーザーがレース予測を見て、自分でファクターを組み合わせて馬券を購入

#### 主な機能

```
┌─────────────────────────────────────────┐
│ UMAYOMI - 今日のレース予測             │
├─────────────────────────────────────────┤
│                                          │
│ 📅 2025年6月1日（日）                  │
│ 🏇 中山競馬場 11R 中山記念（G2）       │
│                                          │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━   │
│                                          │
│ [表示モード選択]                        │
│ ○ 推奨予測（デフォルト）               │
│ ● カスタム予測（ファクター選択）       │
│                                          │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━   │
│                                          │
│ [カスタム予測設定]                      │
│ ┌──────────────────────────────────┐   │
│ │ ファクター選択 (複数選択可):     │   │
│ │                                  │   │
│ │ ☑ 蹄状態×騎手重視   (68.5%)     │   │
│ │ ☐ オッズ逆張り戦略   (71.2%)     │   │
│ │ ☑ 距離適性重視       (65.8%)     │   │
│ │ ☐ 調教師×馬場       (69.3%)     │   │
│ │                                  │   │
│ │ 重み付け:                        │   │
│ │ • 蹄状態×騎手重視: 60%           │   │
│ │ • 距離適性重視: 40%              │   │
│ │                                  │   │
│ │ [予測を再計算]                   │   │
│ └──────────────────────────────────┘   │
│                                          │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━   │
│                                          │
│ [予測結果]                              │
│ ┌──────────────────────────────────┐   │
│ │馬番│馬名      │スコア│評価│オッズ││   │
│ │────┼──────────┼──────┼────┼──────││   │
│ │ 3  │サラブレA │ 92   │ ◎  │ 3.2倍││   │
│ │ 7  │ダービーB │ 85   │ ○  │ 5.8倍││   │
│ │ 1  │スピードC │ 78   │ ▲  │ 8.1倍││   │
│ │ 5  │パワーD   │ 71   │ △  │12.5倍││   │
│ └──────────────────────────────────┘   │
│                                          │
│ 💡 推奨買い目 (期待値順):              │
│ ┌──────────────────────────────────┐   │
│ │ 1. 馬単 3→7 (¥1,000)            │   │
│ │    期待値: 1.8倍 | 的中率: 45%   │   │
│ │                                  │   │
│ │ 2. 三連複 3-7-1 (¥500)           │   │
│ │    期待値: 2.3倍 | 的中率: 22%   │   │
│ │                                  │   │
│ │ 3. ワイド 3-7 (¥500)             │   │
│ │    期待値: 1.5倍 | 的中率: 68%   │   │
│ └──────────────────────────────────┘   │
│                                          │
│ 📊 [詳細分析を見る]                    │
│ 🔄 [別のファクターを試す]              │
│                                          │
└─────────────────────────────────────────┘
```

#### できること
1. ✅ **2つの表示モード**
   - **推奨予測**: CEOが選定した最適ファクターで自動予測
   - **カスタム予測**: ユーザーが自由にファクターを組み合わせ

2. ✅ **ファクター自由選択**
   - 公開されているファクターから複数選択
   - 重み付けを調整して独自の予測を作成

3. ✅ **予測スコア表示**
   - UMAYOMI独自スコア（0-100点）
   - ◎○▲△の評価
   - リアルタイムオッズ表示

4. ✅ **推奨買い目**
   - 馬単、三連複、ワイドなど
   - 期待値（回収率）と的中率を表示
   - ユーザーの予算に応じた買い目提案

5. ✅ **詳細分析**
   - 各馬の強み・弱み
   - 蹄状態、騎手、過去成績など
   - JRDBとJRA-VANの両方のデータを統合表示

---

## データソース

### 1. JRDB（252フィールド）

#### 主要データ
- **KYI**: 馬データ（蹄コード、馬体重、前走成績など）
- **ZKB**: レース前予想データ（IDM、騎手指数、蹄鉄・蹄状態など）
- **BAC**: 馬基本データ（馬名、父母、調教師、騎手など）
- **CHA/JOA/KKA**: 調教師・騎手・競走馬データ
- **OT/OU/OW/OZ**: オッズデータ
- **ZED**: レース詳細データ（場コード、距離、馬場状態など）
- **UKC**: 馬成績データ（芝・ダート別成績）

#### データ期間
- 2016年～2025年（約10年間）
- 約1,043日分
- 総データ量: 約508MB

---

### 2. JRA-VAN（TFJVデータ）

#### 主要データ
- **レース結果**: 着順、タイム、通過順位
- **払戻金**: 単勝、複勝、馬連、馬単、三連複、三連単
- **馬実績**: 芝・ダート・距離別成績
- **血統データ**: 父馬、母馬、母父馬
- **調教データ**: 調教タイム、調教コース

#### データ期間
- 2016年～2025年（約10年間）
- 約1,450ファイル
- 総データ量: 約455MB

---

### データ統合

```sql
-- 例: JRDBとJRA-VANを統合したビュー
CREATE VIEW race_analysis AS
SELECT 
  -- JRDB
  j.race_key,
  j.horse_number,
  j.horse_name,
  j.hoof_code,          -- 蹄コード
  j.jockey_index,       -- 騎手指数
  j.horse_weight,       -- 馬体重
  
  -- JRA-VAN
  t.past_3_races_avg,   -- 過去3走平均着順
  t.turf_win_rate,      -- 芝勝率
  t.dirt_win_rate,      -- ダート勝率
  t.distance_record     -- 距離別成績
  
FROM jrdb_kyi j
LEFT JOIN tfjv_race t ON j.race_key = t.race_key AND j.horse_number = t.horse_number;
```

---

## ファクター設計

### ファクター定義構造

```typescript
interface Factor {
  id: string;
  name: string;
  description: string;
  author: 'ceo' | 'user';
  is_public: boolean;
  
  // データソース
  data_sources: {
    jrdb: boolean;
    jravan: boolean;
  };
  
  // 条件設定
  conditions: {
    jrdb?: {
      hoof_code?: number[];      // 蹄コード
      jockey_index?: {min: number, max: number};
      horse_weight_change?: {min: number, max: number};
      // ... 他のJRDBフィールド
    };
    jravan?: {
      past_3_races_avg?: {min: number, max: number};
      turf_win_rate?: {min: number};
      // ... 他のJRA-VANフィールド
    };
  };
  
  // 重み付け
  weights: {
    [key: string]: number;  // 合計100%
  };
  
  // バックテスト結果
  backtest: {
    accuracy: number;       // 的中率
    roi: number;            // 回収率
    sample_size: number;    // サンプル数
    period: {
      start: string;
      end: string;
    };
  };
}
```

### ファクター例

```typescript
const factor_example: Factor = {
  id: 'f001',
  name: '蹄状態×騎手重視',
  description: '蹄状態が良好で騎手指数が高い馬を優先',
  author: 'ceo',
  is_public: true,
  
  data_sources: {
    jrdb: true,
    jravan: true
  },
  
  conditions: {
    jrdb: {
      hoof_code: [11, 12, 13],  // 良好な蹄コード
      jockey_index: {min: 70, max: 100}
    },
    jravan: {
      past_3_races_avg: {min: 1, max: 3},
      turf_win_rate: {min: 0.3}
    }
  },
  
  weights: {
    'jrdb_hoof': 30,
    'jrdb_jockey': 25,
    'jravan_past': 25,
    'horse_weight': 20
  },
  
  backtest: {
    accuracy: 68.5,
    roi: 112.3,
    sample_size: 1250,
    period: {
      start: '2023-01-01',
      end: '2024-12-31'
    }
  }
};
```

---

## ワークフロー

### 完全版ワークフロー

```
┌─────────────────────────────────────────┐
│ 開発者モード（CEO専用）                 │
└─────────────┬───────────────────────────┘
              ↓
    ┌─────────────────────┐
    │ ファクター作成      │
    │ • JRDBデータ選択    │
    │ • JRA-VANデータ選択 │
    │ • 条件設定          │
    │ • 重み付け調整      │
    └─────────┬───────────┘
              ↓
    ┌─────────────────────┐
    │ バックテストで検証  │
    │ • 的中率計算        │
    │ • 回収率計算        │
    │ • 馬場別分析        │
    └─────────┬───────────┘
              ↓
    ┌─────────────────────┐
    │ 最適なファクターを  │
    │ 選定（任意）        │
    │ • 公開/非公開選択   │
    └─────────┬───────────┘
              ↓
┌─────────────────────────────────────────┐
│ ユーザーモード（一般公開）              │
├─────────────────────────────────────────┤
│             ↓                           │
│   ┌─────────────────────┐              │
│   │ 予測結果を表示      │              │
│   │ • 推奨予測          │              │
│   │   (CEOが選定)       │              │
│   │ または              │              │
│   │ • カスタム予測      │              │
│   │   (ユーザーが       │              │
│   │    ファクター選択)  │              │
│   └─────────┬───────────┘              │
│             ↓                           │
│   ┌─────────────────────┐              │
│   │ ユーザーが          │              │
│   │ 馬券購入（任意）    │              │
│   └─────────┬───────────┘              │
│             ↓                           │
│   ┌─────────────────────┐              │
│   │ 結果をフィードバック│              │
│   │ • 的中/不的中記録   │              │
│   │ • 配当金記録        │              │
│   └─────────┬───────────┘              │
└─────────────┼───────────────────────────┘
              ↓
    ┌─────────────────────┐
    │ 開発者モードで改善  │
    │ • フィードバック分析│
    │ • ファクター調整    │
    │ • 再バックテスト    │
    └─────────────────────┘
```

---

## 技術スタック

### フロントエンド
- **HTML5**
- **TailwindCSS**: スタイリング
- **Chart.js**: グラフ表示
- **Vanilla JavaScript**: インタラクション

### バックエンド
- **Hono (TypeScript)**: Webフレームワーク
- **Node.js**: サーバーサイドロジック

### データベース
- **PostgreSQL**: メインデータベース
  - JRDBデータ（252フィールド）
  - JRA-VANデータ（TFJV）
  - ファクター定義
  - バックテスト結果

### デプロイ
- **Cloudflare Pages**: 静的サイトホスティング
- **Cloudflare Workers**: エッジコンピューティング
- **Cloudflare D1**: エッジSQLite（オプション）

### データ処理
- **Python**: JRDBパーサー（Shift_JIS対応）
- **pandas**: データ処理
- **SQLAlchemy**: ORM

---

## 開発フェーズ

### Phase 1-3: 完了 ✅
- ✅ JRDBデータ調査
- ✅ データ構造設計
- ✅ PostgreSQLテーブル設計

### Phase 4: 進行中 🔄
- 🔄 蹄データ抽出実装 ← **今ココ**
- ⏳ Shift_JIS版ファイル取得待ち

### Phase 5: 全データ取り込み ⏳
- ⏳ JRDB 252フィールド完全取り込み
- ⏳ JRA-VAN TFJVデータ取り込み
- ⏳ データ正規化・クリーニング

### Phase 6: 開発者モード構築 ⏳
- ⏳ ファクター作成UI
- ⏳ バックテスト機能
- ⏳ データソース選択機能（JRDB + JRA-VAN）

### Phase 7: ファクターエンジン ⏳
- ⏳ 予測スコア計算ロジック
- ⏳ 重み付け処理
- ⏳ リアルタイム予測

### Phase 8: ユーザーモード構築 ⏳
- ⏳ 予測表示UI
- ⏳ カスタム予測機能（ファクター選択）
- ⏳ 推奨買い目生成

### Phase 9: デプロイ ⏳
- ⏳ Cloudflare Pages デプロイ
- ⏳ ドメイン設定
- ⏳ SSL証明書

### Phase 10: 運用・改善 ⏳
- ⏳ ユーザーフィードバック収集
- ⏳ ファクター精度向上
- ⏳ 新機能追加

---

## まとめ

### UMAYOMIの強み
1. **マルチデータソース**: JRDBとJRA-VANの両方を活用
2. **柔軟なファクター設計**: CEOとユーザーの両方がカスタマイズ可能
3. **データ駆動型**: 10年分のビッグデータで精度向上
4. **高速開発**: 48時間で市場投入

### 最終目標
**「勘」を「確信」に変える。競馬予測の精度を10倍にし、的中率と回収率を最大化する。**

---

**UMAYOMI - 馬を読む。レースが変わる。** 🚀

---

**ドキュメント更新日**: 2025-12-31  
**バージョン**: 1.0.0  
**作成者**: Enable CEO + Claude Code Agent
