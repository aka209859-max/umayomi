# RGS1.0計算式 - クイックリファレンス（他AI引き継ぎ用）

**最終更新**: 2026-01-04

---

## 📋 このドキュメントについて

このドキュメントは、RGS1.0（Racing Grade Score）計算を他のAIに引き継ぐための簡潔なリファレンスです。  
詳細版は `RGS10_FORMULA_COMPLETE.md` を参照してください。

---

## 🎯 RGS1.0とは

- **スコア範囲**: -10.0 ～ +10.0
- **評価方式**: 絶対評価（固定基準80%との乖離を評価）
- **目的**: ファクターの絶対的な収益力を数値化
- **用途**: 「このファクターは儲かるのか？」を判断

### AASとの違い

| 項目 | RGS1.0 | AAS |
|------|---------|-----|
| 評価方式 | **絶対評価** | 相対評価 |
| 基準 | 固定（80%） | グループ平均 |
| スコア範囲 | -10 ～ +10 | -12 ～ +12 |
| 用途 | 収益力の絶対値 | グループ内順位 |

---

## 📊 入力データ

| 変数名 | 説明 | 必須 |
|--------|------|------|
| `cntWin` | 単勝件数 | ✅ |
| `cntPlace` | 複勝件数 | ✅ |
| `adjWinRet` | **単勝補正回収率**（%） | ✅ |
| `adjPlaceRet` | **複勝補正回収率**（%） | ✅ |

**⚠️ 最重要**: 生の回収率ではなく、**補正回収率**を使用してください！

---

## 🧮 計算式（7ステップ）

### Step 1: 総件数
```
W = cntWin + cntPlace
```

### Step 2: 信頼度
```
X = MIN(1, SQRT(W / 500))
```

### Step 3: 加重回収率
```
Y = adjWinRet × 0.3 + adjPlaceRet × 0.7
```

### Step 4: 乖離
```
Z = Y - 80
```

### Step 5: 調整乖離
```
AA = Z × X
```

### Step 6: 正規化
```
AB = AA / 25
```

### Step 7: 最終スコア
```
RGS1.0 = 10 × TANH(AB)
```

---

## 🔢 重要な係数（変更禁止）

| 項目 | 係数 |
|------|------|
| 単勝の重み | 0.3 |
| 複勝の重み | 0.7 |
| 基準回収率 | 80% |
| 信頼度基準件数 | 500件 |
| 正規化係数 | 25 |
| スケール係数 | 10 |

---

## 💻 Python実装（最小版）

```python
import math

def calculate_rgs10(cnt_win, cnt_place, adj_win_ret, adj_place_ret):
    """RGS1.0を計算"""
    
    # Step 1: 総件数
    W = cnt_win + cnt_place
    
    # Step 2: 信頼度
    X = min(1, math.sqrt(W / 500))
    
    # Step 3: 加重回収率
    Y = adj_win_ret * 0.3 + adj_place_ret * 0.7
    
    # Step 4: 乖離
    Z = Y - 80
    
    # Step 5: 調整乖離
    AA = Z * X
    
    # Step 6: 正規化
    AB = AA / 25
    
    # Step 7: 最終スコア
    rgs_score = 10 * math.tanh(AB)
    
    return {
        'rgs_score': round(rgs_score, 2),
        'total_count': W,
        'reliability': round(X, 4),
        'weighted_return_rate': round(Y, 2),
        'deviation': round(Z, 2)
    }

# テスト実行
result = calculate_rgs10(
    cnt_win=11,
    cnt_place=16,
    adj_win_ret=175.1,
    adj_place_ret=66.4
)

print(f"RGS1.0スコア: {result['rgs_score']}")
# 期待値: 1.75
```

---

## 📝 Excel実装（LET関数）

```excel
=LET(
    H, 単勝件数,
    L, 複勝件数,
    Q, 単勝補正回収率,
    T, 複勝補正回収率,
    
    W, H + L,
    X, MIN(1, SQRT(W/500)),
    Y, Q*0.3 + T*0.7,
    Z, Y - 80,
    AA, Z * X,
    AB, AA / 25,
    
    ROUND(10 * TANH(AB), 2)
)
```

---

## 📝 Excel実装（分割セル）

| 列 | セル名 | 式 |
|----|--------|-------|
| W | 総件数 | `=H2+L2` |
| X | 信頼度 | `=MIN(1,SQRT(W2/500))` |
| Y | 加重回収率 | `=Q2*0.3+T2*0.7` |
| Z | 乖離 | `=Y2-80` |
| AA | 調整乖離 | `=Z2*X2` |
| AB | 正規化 | `=AA2/25` |
| AC | RGS1.0 | `=ROUND(10*TANH(AB2),2)` |

---

## 🧪 検証用テストケース

### テストケース1: やや良好（ドキュメント例）

**入力**:
```
cntWin = 11件
cntPlace = 16件
adjWinRet = 175.1%
adjPlaceRet = 66.4%
```

**計算過程**:
```
W = 11 + 16 = 27件
X = SQRT(27/500) = 0.2324
Y = 175.1×0.3 + 66.4×0.7 = 99.01%
Z = 99.01 - 80 = 19.01pt
AA = 19.01 × 0.2324 = 4.42
AB = 4.42 / 25 = 0.1768
TANH(0.1768) = 0.1749
RGS1.0 = 10 × 0.1749 = 1.749
```

**期待される出力**:
```
RGS1.0 = 1.75 (±0.02の誤差許容)
評価: ★★★★☆☆ やや良好
```

---

### テストケース2: 超優良

**入力**:
```
cntWin = 100件, cntPlace = 100件
adjWinRet = 200.0%, adjPlaceRet = 180.0%
```

**期待される出力**:
```
RGS1.0 = 9.91
評価: ★★★★★★ 超優良レース
```

---

### テストケース3: 平均的

**入力**:
```
cntWin = 30件, cntPlace = 30件
adjWinRet = 80.0%, adjPlaceRet = 80.0%
```

**期待される出力**:
```
RGS1.0 = 0.00
評価: ★★★☆☆☆ 平均的
```

---

### テストケース4: 不良

**入力**:
```
cntWin = 20件, cntPlace = 20件
adjWinRet = 40.0%, adjPlaceRet = 50.0%
```

**期待される出力**:
```
RGS1.0 = -3.56
評価: ★★☆☆☆☆ やや不良
```

---

## ⚠️ よくあるミス（必読）

### 1. 補正回収率を使っていない（最重要！）

```
❌ ret_raw = rateWinRet, ratePlaceRet
✅ ret_raw = adjWinRet, adjPlaceRet
```

### 2. 信頼度の計算ミス

```
❌ X = SQRT(W) / 500
✅ X = SQRT(W / 500)
```

### 3. 加重回収率の係数ミス

```
❌ Y = adjWinRet×0.5 + adjPlaceRet×0.5
✅ Y = adjWinRet×0.3 + adjPlaceRet×0.7
```

### 4. 基準回収率の誤り

```
❌ Z = Y - 100
✅ Z = Y - 80
```

### 5. 正規化係数の誤り

```
❌ AB = AA / 10
✅ AB = AA / 25
```

### 6. TANH関数の省略

```
❌ rgsScore = 10 * AB
✅ rgsScore = 10 * TANH(AB)
```

---

## 📈 スコア解釈

| RGS1.0 | 評価 | 意味 | 戦略 |
|--------|------|------|------|
| +7.0以上 | ★★★★★★ | 超優良 | 全力投資 |
| +4.0～+6.9 | ★★★★★☆ | 優良 | 積極的に狙う |
| +1.0～+3.9 | ★★★★☆☆ | やや良好 | 条件次第で |
| -1.0～+0.9 | ★★★☆☆☆ | 平均的 | 慎重に |
| -4.0～-1.1 | ★★☆☆☆☆ | やや不良 | 避けるべき |
| -10.0～-4.1 | ★☆☆☆☆☆ | 避けるべき | 絶対避ける |

---

## 🎯 実務的な目安

| RGS1.0 | 加重回収率 | 評価 |
|--------|-----------|------|
| +8.0 | 150%以上 | 🔥 超優良 |
| +5.0 | 120-150% | ✅ 優良 |
| +2.0 | 95-120% | 👍 やや良好 |
| 0.0 | 80% | ⚠️ 平均的 |
| -3.0 | 60-80% | ❌ 不良 |
| -6.0 | 50%以下 | 🚫 超不良 |

---

## ✅ 実装チェックリスト

実装したら、以下を確認してください：

- [ ] **補正回収率**（adjWinRet, adjPlaceRet）を使用
- [ ] 総件数 = cntWin + cntPlace
- [ ] 信頼度 = MIN(1, SQRT(総件数/500))
- [ ] 加重回収率 = adjWinRet×0.3 + adjPlaceRet×0.7
- [ ] 乖離 = 加重回収率 - 80
- [ ] 調整乖離 = 乖離 × 信頼度
- [ ] 正規化 = 調整乖離 / 25
- [ ] 最終スコア = 10 × TANH(正規化)
- [ ] 小数点2桁で丸める
- [ ] テストケースで検証（±0.02の誤差内）

---

## 📚 参考資料

- 詳細版: `RGS10_FORMULA_COMPLETE.md`
- 実装例: `src/utils/rgs10.ts`
- AAS計算式: `AAS_FORMULA_COMPLETE.md`

---

**このドキュメントを他のAIに渡せば、RGS1.0計算を正確に実装できます。**
