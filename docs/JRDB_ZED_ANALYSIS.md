# JRDB ZEDファイル分析レポート

## 📋 背景

CEOからの指示：
- JRDBデータ（1,265ファイル、2.9GB）を完全取り込み
- ZEDファイルから優先的に取り込む
- RGS/AAS計算の基盤データとして使用

## 🔍 ZEDファイルの実態

### ファイル構造
- **ファイル数**: 1,265ファイル
- **エンコーディング**: Shift-JIS
- **1行のバイト数**: 536バイト（当初の想定453バイトではない）
- **データ形式**: 固定長フォーマット

### データ内容

**重要な発見**: ZEDは**レース情報ファイルではなく、馬別の詳細成績データ**でした。

各行の構造（推定）:
```
位置    内容
0-2     場コード
2-4     レース番号
4-6     曜日
6-8     月
8-10    日
10-18   レースID
18-26   開催年月日 (YYYYMMDD)
26-76   レース名 (50バイト)
76-78   グレード
78-?    馬番、着順、オッズ、騎手、調教師、馬体重、通過順位など
```

### サンプルデータ（デコード前）
```
06245401112210102220241208Ｗインスタグラム�@�@12002111111A31023...
```

### サンプルデータ（正しくパース後）の推測
```
レース日: 20241208
場コード: 06 (東京)
レース番号: 24
レース名: Ｗインスタグラム
馬番: 12
着順: 1
人気: 1
オッズ: 2.1
...
```

## ⚠️ 問題点

### 1. フォーマット仕様の不明確さ
- Pythonパーサーの定義（453バイト）と実際のファイル（536バイト）が一致しない
- フィールドの正確な位置が不明

### 2. 既存テーブルとの重複
- `jrdb_zed`テーブルは既に存在（払戻データ用）
- 新しく`jrdb_zed_race`テーブルを作成したが、実際はレース情報ではなく馬別データ

### 3. 現在のパース結果
```
総レコード数: 6,592 (4ファイルから)
問題:
- 距離: すべて0
- 出走頭数: すべて0  
- 賞金: すべて0
- レース名: 文字化け
```

## ✅ 成功した部分

### 取り込みパフォーマンス
- **速度**: 15,465 records/sec
- **処理時間**: 0.43秒（4ファイル）
- **スケール推定**: 1,265ファイル = 約2分

### 技術スタック
- ✅ Shift-JIS デコード（iconv-lite）
- ✅ better-sqlite3 直接書き込み
- ✅ トランザクション処理
- ✅ 重複防止（UNIQUE制約）

## 🚀 次のアクション（提案）

### Option A: ZED完全パーサー実装（推奨時間: 60分）

**メリット**:
- 最も正確なデータ取得
- 全1,265ファイル（推定200万件以上）を完全取り込み
- RGS/AAS計算に最適なデータ構造

**デメリット**:
- フォーマット仕様の調査が必要
- 実装時間がかかる

**実装ステップ**:
1. 既存のJRDB公式仕様書を探す
2. サンプルファイルから逆エンジニアリング
3. 各フィールドの位置を特定
4. パーサー実装・テスト
5. 全1,265ファイル取り込み

### Option B: JRDBの他のファイル優先（推奨時間: 30分）

**KKA（確定着順）やSED（成績データ）を先に取り込み**

**メリット**:
- フォーマットが比較的単純
- RGS/AAS計算に必要な最小限のデータを確保
- 早期にロジックテスト可能

**デメリット**:
- ZED（最も詳細なデータ）は後回し

### Option C: JRA-VAN優先（推奨時間: 15分）

**既存のjravan_seパーサーを活用してRGS/AAS計算を先に実装**

**メリット**:
- 既存データ（2,121,020件）が使用可能
- raw_dataパーサーは既に実装済み
- 最速でRGS/AAS計算のテスト開始

**デメリット**:
- JRDBデータは未使用のまま
- データの多様性が限定的

## 📊 データ取り込み状況サマリー

| データソース | 状態 | 件数 | 次のステップ |
|------------|-----|------|------------|
| JRA-VAN | ✅ 完了 | 20,353,837 | raw_dataパーサー実装待ち |
| JRDB hjc/ov | ✅ 完了 | 33,348 | 使用可能 |
| JRDB ZED | 🔄 パース問題あり | 6,592 (4ファイルのみ) | フォーマット調査必要 |
| JRDB その他 | ❌ 未着手 | 0 | 優先度検討 |

## 💡 CEO への質問

**どのOptionで進めますか？**

1. **Option A**: ZED完全パーサー実装（60分、最も正確）
2. **Option B**: KKA/SED優先（30分、バランス型）
3. **Option C**: JRA-VAN優先（15分、最速）

---

**作成日時**: 2026-01-04
**作成者**: CSO (Chief Strategy Officer)
**ステータス**: CEOの決定待ち
