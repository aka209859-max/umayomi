# Phase 3-2: JRDB データ解析結果

## 📊 データ構造概要

### **ファイル統計**

```
E:\UMAYOMI\downloads_weekly\
├── sed/    513個のZIPファイル（成績データ）
├── tyb/    513個のZIPファイル（出馬表データ）
├── hjc/    515個のZIPファイル（払戻金データ）
└── ov/     513個のZIPファイル（オッズデータ）

合計: 2,054個のZIPファイル
```

### **サンプルファイル（2016/01/09）**

| ファイル | 行数 | レコード長 | サイズ | 内容 |
|---------|------|-----------|--------|------|
| SED160109.txt | 360行 | 375バイト | 133KB | レース成績データ |
| TYB160109.txt | 360行 | 375バイト | 45KB | 出馬表データ |
| HJC160109.txt | 24行 | 375バイト | 11KB | 払戻金データ |
| OV160109.txt | 24行 | 33,600バイト | 804KB | オッズデータ（超大容量） |

---

## 🔍 レコード構造解析

### **1. SED（成績データ）- 375バイト/行**

**サンプル（最初の1行）:**
```
06161201011310345720160109コースレース番号馬情報...   8.904  3  3 -6     333823SS-13.3-43.0 -4.0  0.0...
```

**フィールド構造（推定）:**
```
[0-2]    場コード（06=京都）
[2-4]    年（16=2016年）
[4-6]    月日（1201=12月01日）
[6-8]    レース番号（01）
[8-10]   馬番（01）
[10-18]  レース情報
[18-26]  日付（20160109）
[26-X]   馬名（Shift-JIS、可変長）
...
[X-X+7]  タイム（8.904 = 8分90.4秒？）
[X+7-X+10] 着順（3）
[X+10-X+13] 人気（3）
...
```

### **2. TYB（出馬表データ）- 375バイト/行**

**サンプル（最初の1行）:**
```
0616120101 20.0  1.4  2.6  2.5  3.0  0.0 29.512030113馬名5600101   8.3   1.70935510+ 4326
```

**フィールド構造（推定）:**
```
[0-10]   レースキー（0616120101）
[10-16]  オッズ1（20.0）
[16-22]  オッズ2（1.4）
[22-28]  オッズ3（2.6）
[28-34]  オッズ4（2.5）
[34-40]  オッズ5（3.0）
[40-46]  オッズ6（0.0）
[46-52]  合計オッズ（29.5）
[52-63]  その他情報（12030113）
[63-X]   馬名（Shift-JIS）
[X-X+7]  血統コード（5600101）
[X+7-X+12] 指数1（8.3）
[X+12-X+17] 指数2（1.7）
...
```

### **3. HJC（払戻金データ）- 375バイト/行**

**サンプル（最初の1行）:**
```
0616120103    20000      000      003    11008    14010    32000...
```

**フィールド構造（推定）:**
```
[0-10]   レースキー（0616120103）
[10-20]  単勝払戻金（20000=2,000円）
[20-30]  複勝払戻金1（000）
[30-40]  複勝払戻金2（003）
[40-50]  馬連払戻金（11008=1,100.8円？）
[50-60]  馬単払戻金（14010）
[60-70]  ワイド払戻金（32000）
...
```

### **4. OV（オッズデータ）- 33,600バイト/行**

**特徴:**
- **超大容量**: 1行あたり33,600バイト（33KB）
- **内容**: 全馬の単勝・複勝・馬連・馬単・ワイド・三連複・三連単オッズ
- **構造**: 固定長フィールドの連続

**サンプル（一部）:**
```
061612011600024180056894008264900092330021311000431700468670014266006404200145280052725000560600108890021766...
```

**フィールド構造（推定）:**
```
[0-10]   レースキー（0616120116）
[10-18]  オッズ1（00024180 = 24.180）
[18-26]  オッズ2（00056894 = 56.894）
[26-34]  オッズ3（00826490 = 826.490）
...
（この後、数百〜数千のオッズ値が続く）
```

---

## 💡 実装戦略

### **Phase 3-2: パーサー実装（60分）**

#### **Step 1: SEDParser（成績データ）- 20分**
- 固定長375バイトのレコードをパース
- レースキー、馬番、着順、人気、タイムを抽出
- D1の `race_results` テーブルへINSERT

#### **Step 2: TYBParser（出馬表データ）- 20分**
- 固定長375バイトのレコードをパース
- レースキー、馬番、オッズ、指数を抽出
- D1の `horses` テーブルへINSERT

#### **Step 3: HJCParser（払戻金データ）- 10分**
- 固定長375バイトのレコードをパース
- レースキー、単勝・複勝・馬連などの払戻金を抽出
- D1の `races` テーブルへUPDATE

#### **Step 4: OVParser（オッズデータ）- 10分（暫定保留）**
- **判断**: オッズデータは超大容量（33KB/レース）のため、Phase 4以降で実装
- **理由**: 48時間以内の完成を優先し、コアデータ（SED/TYB/HJC）を先に処理

---

## 📋 次のステップ

### **Phase 3-3: バッチインポートスクリプト（25分）**

```typescript
// scripts/import_jrdb_batch.ts

import { SEDParser, TYBParser, HJCParser } from '../src/parsers/JRDBParser'
import { unzipSync } from 'fflate'
import { readFileSync, readdirSync } from 'fs'

async function importJRDBData() {
  const baseDir = 'E:\\UMAYOMI\\downloads_weekly'
  
  // SEDファイルを処理
  const sedFiles = readdirSync(`${baseDir}\\sed`)
  for (const file of sedFiles) {
    const zipData = readFileSync(`${baseDir}\\sed\\${file}`)
    const unzipped = unzipSync(zipData)
    const txtData = new TextDecoder('shift-jis').decode(unzipped['SED*.txt'])
    
    const lines = txtData.split('\n')
    for (const line of lines) {
      const result = SEDParser.parse(line)
      // D1へINSERT
    }
  }
  
  // TYB, HJCも同様に処理
}
```

---

## ⏱️ タイムライン

```
✅ Phase 0-2: 完了（5時間）
✅ Phase 3-1: D1テーブル設計（1時間）
⏳ Phase 3-2: パーサー実装（1時間） ← 今ここ！
  ├─ Step 1: SEDParser（20分）
  ├─ Step 2: TYBParser（20分）
  ├─ Step 3: HJCParser（10分）
  └─ Step 4: OVParser（10分、暫定保留）
⏳ Phase 3-3: バッチインポート（25分）

経過時間: 6時間
残り時間: 42時間
```

---

## 🎯 推定データ量

### **D1へのインポート量（軽量データのみ）**

| テーブル | 推定行数 | 推定サイズ | 備考 |
|---------|---------|-----------|------|
| races | 10,430レース | 1MB | レース基本情報 + HJC払戻金 |
| race_results | 約100,000頭 | 10MB | SEDから全着順データ |
| horses | 約1,000頭 | 500KB | TYBから馬情報 |
| **合計** | **約111,430行** | **約12MB** | **D1無料プラン内** |

### **E:ドライブに保持（重量データ）**

| データ | ファイル数 | 合計サイズ | 備考 |
|--------|-----------|-----------|------|
| OVオッズデータ | 513ファイル | 約400MB | 必要時に読み込み |
| その他JRA-VANデータ | 多数 | 約9GB | 将来の拡張用 |

---

## 📌 メモ

- **文字コード**: Shift-JIS（日本語対応必須）
- **レコード長**: SED/TYB/HJC = 375バイト、OV = 33,600バイト
- **データ品質**: 固定長レコードのため、パース精度が高い
- **スケーラビリティ**: 513週間（約10年分）のデータを処理可能
