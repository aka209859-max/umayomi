<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>明日のレース分析 - UMAYOMI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
    <style>
        .horse-table {
            font-size: 14px;
        }
        .horse-table th {
            background-color: #f3f4f6;
            font-weight: 600;
            padding: 12px;
            border: 1px solid #d1d5db;
            text-align: center;
        }
        .horse-table td {
            padding: 10px 12px;
            border: 1px solid #e5e7eb;
            text-align: center;
        }
        .horse-table tr:hover {
            background-color: #f9fafb;
        }
        .score-high {
            color: #dc2626;
            font-weight: 700;
            font-size: 16px;
        }
        .score-medium {
            color: #f97316;
            font-weight: 600;
            font-size: 15px;
        }
        .score-low {
            color: #6b7280;
            font-weight: 500;
        }
        .score-negative {
            color: #2563eb;
            font-weight: 500;
        }
        .factor-badge {
            display: inline-block;
            padding: 4px 8px;
            margin: 2px;
            background-color: #dbeafe;
            color: #1e40af;
            border-radius: 4px;
            font-size: 12px;
        }
        .loading {
            display: none;
        }
        .loading.active {
            display: block;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="container mx-auto px-4 py-6">
        <!-- ヘッダー -->
        <div class="bg-white shadow-sm rounded-lg p-6 mb-6">
            <h1 class="text-2xl font-bold text-gray-800 mb-2">
                <i class="fas fa-calendar-day mr-2 text-green-600"></i>
                明日のレース分析
            </h1>
            <p class="text-gray-600" id="dateDisplay">読み込み中...</p>
        </div>

        <!-- ローディング表示 -->
        <div id="loading" class="loading active text-center py-8">
            <i class="fas fa-spinner fa-spin text-blue-600 text-3xl"></i>
            <p class="text-gray-600 mt-4">レースデータを読み込み中...</p>
        </div>

        <!-- エラー表示 -->
        <div id="error" class="hidden mb-6 p-4 bg-red-50 border border-red-200 rounded-lg">
            <p class="text-red-600"><i class="fas fa-exclamation-circle mr-2"></i><span id="errorMessage"></span></p>
        </div>

        <!-- レース一覧 -->
        <div id="racesContainer"></div>
    </div>

    <script>
        // グローバル変数
        let racesData = [];

        /**
         * 初期化
         */
        async function init() {
            await loadTomorrowRaces();
        }

        /**
         * 明日のレースを読み込み
         */
        async function loadTomorrowRaces() {
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            const dateDisplay = document.getElementById('dateDisplay');
            
            error.classList.add('hidden');
            loading.classList.add('active');
            
            try {
                const response = await axios.get('/api/races/tomorrow');
                
                if (response.data.success) {
                    racesData = response.data.races;
                    const raceDate = response.data.date;
                    
                    // 日付表示を更新
                    dateDisplay.textContent = `${raceDate}（${racesData.length}レース）`;
                    
                    // レース一覧を表示
                    renderRaces(racesData);
                } else {
                    showError('レースデータの取得に失敗しました: ' + response.data.error);
                }
            } catch (err) {
                console.error('API Error:', err);
                showError('API呼び出しエラー: ' + (err.response?.data?.message || err.message));
            } finally {
                loading.classList.remove('active');
            }
        }

        /**
         * レース一覧を表示
         */
        function renderRaces(races) {
            const container = document.getElementById('racesContainer');
            container.innerHTML = '';

            if (races.length === 0) {
                container.innerHTML = '<div class="bg-white shadow-sm rounded-lg p-6 text-center text-gray-500">明日のレースはありません</div>';
                return;
            }

            races.forEach(race => {
                const raceCard = createRaceCard(race);
                container.appendChild(raceCard);
            });
        }

        /**
         * レースカードを作成
         */
        function createRaceCard(race) {
            const card = document.createElement('div');
            card.className = 'bg-white shadow-sm rounded-lg p-6 mb-6';
            
            // レースヘッダー
            const header = `
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-gray-800">
                        <i class="fas fa-horse-head mr-2 text-green-600"></i>
                        ${race.raceName}
                    </h2>
                    <div class="text-sm text-gray-600">
                        <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full mr-2">${race.venue}</span>
                        <span class="px-3 py-1 bg-green-100 text-green-800 rounded-full mr-2">${race.surface}</span>
                        <span class="px-3 py-1 bg-purple-100 text-purple-800 rounded-full">${race.distance}</span>
                    </div>
                </div>
            `;
            
            // 出走馬テーブル
            const horsesTable = createHorsesTable(race.horses);
            
            card.innerHTML = header + horsesTable;
            return card;
        }

        /**
         * 出走馬テーブルを作成
         */
        function createHorsesTable(horses) {
            // 総合AASスコアでソート
            const sortedHorses = [...horses].sort((a, b) => b.totalAasScore - a.totalAasScore);
            
            let tableHtml = `
                <div class="overflow-x-auto">
                    <table class="horse-table w-full border-collapse">
                        <thead>
                            <tr>
                                <th style="width: 60px;">馬番</th>
                                <th style="width: 200px;">馬名</th>
                                <th style="width: 120px;">騎手</th>
                                <th style="width: 120px;">調教師</th>
                                <th style="width: 100px;">総合AAS</th>
                                <th style="width: 100px;">総合RGS</th>
                                <th style="width: 80px;">該当<br>ファクター数</th>
                                <th>該当ファクター詳細</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            sortedHorses.forEach(horse => {
                const aasClass = getScoreClass(horse.totalAasScore);
                const rgsClass = getScoreClass(horse.totalRgsScore);
                const factorDetails = createFactorDetails(horse.matchedFactors);
                
                tableHtml += `
                    <tr>
                        <td><strong>${horse.horseNumber}</strong></td>
                        <td class="text-left font-semibold">${horse.horseName}</td>
                        <td>${horse.jockeyName}</td>
                        <td>${horse.trainerName}</td>
                        <td class="${aasClass}">${formatScore(horse.totalAasScore)}</td>
                        <td class="${rgsClass}">${formatScore(horse.totalRgsScore)}</td>
                        <td><span class="px-2 py-1 bg-gray-100 rounded">${horse.matchedFactorCount}</span></td>
                        <td class="text-left">${factorDetails}</td>
                    </tr>
                `;
            });
            
            tableHtml += `
                        </tbody>
                    </table>
                </div>
            `;
            
            return tableHtml;
        }

        /**
         * ファクター詳細を作成
         */
        function createFactorDetails(factors) {
            if (factors.length === 0) {
                return '<span class="text-gray-400">該当なし</span>';
            }
            
            return factors.map(f => {
                const keys = f.keys.filter(k => k).join(' × ');
                return `<div class="factor-badge" title="${f.factorName}">
                    ${keys} (AAS: ${formatScore(f.aasScore)}, RGS: ${formatScore(f.rgsScore)})
                </div>`;
            }).join('');
        }

        /**
         * スコアのCSSクラスを取得
         */
        function getScoreClass(score) {
            if (score >= 3.0) return 'score-high';
            if (score >= 1.0) return 'score-medium';
            if (score >= 0) return 'score-low';
            return 'score-negative';
        }

        /**
         * スコアをフォーマット
         */
        function formatScore(score) {
            const sign = score >= 0 ? '+' : '';
            return `${sign}${score.toFixed(2)}`;
        }

        /**
         * エラーメッセージを表示
         */
        function showError(message) {
            const error = document.getElementById('error');
            const errorMessage = document.getElementById('errorMessage');
            errorMessage.textContent = message;
            error.classList.remove('hidden');
        }

        // 初期化実行
        init();
    </script>
</body>
</html>
